---
title: Purchasing offers
description: How to purchase e-commerce offers.
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import Blueprint from "@site/src/Blueprint";

import bpCheckout from "./purchasing/checkout.bp";
import bpConsume from "./purchasing/consume.bp";
import bpFinalize from "./purchasing/finalize.bp";
import bpQuery from "./purchasing/query.bp";

E-commerce functionality is provided via the `IOnlineStoreV2`, `IOnlineEntitlements` and `IOnlinePurchase` interfaces. Purchasing items is done via the `IOnlinePurchase` interface.

## Platform support

<Tabs lazy groupId="ecom-platform" defaultValue="steam" values={[ { label: 'Epic Games Store', value: 'egs' }, { label: 'Steam', value: 'steam' }, { label: 'Google Play', value: 'google-play' } ]}>
<TabItem value="egs">

When purchasing offers on Epic Games Store, you'll get the callback from `Checkout` once the entire checkout process has completed or otherwise been cancelled.

You can purchase multiple items at a time with EGS e-commerce, but the quantity of each item must always be 1. Epic Games Store does not support purchasing the same item multiple times in a single checkout request.

Refer to [Initating a purchase](#initating-a-purchase-on-any-platform) for an example on how to purchase one or more offers.

If you want to consume an item after it's been purchased, refer to [Consuming an entitlement on Epic Games Store](#consuming-an-entitlement-on-epic-games-store).

While the checkout process is in progress, you will see a temporary receipt in `GetReceipts` that represents the in progress transaction. After the purchase completes successfully, the transaction ID of the receipt will be updated to the actual transaction ID provided by Epic Games Store.

:::caution
Epic Games Store e-commerce only works from packaged games. You must packaged the game on Windows so that the EOS bootstrapper launches the game, and then test Epic Games Store e-commerce from there.
:::

</TabItem>
<TabItem value="steam">

When purchasing offers on Steam, there is no notification for a successful purchase. You can initiate a purchase, and observe the change in entitlements by polling `IOnlineEntitlements`, but the purchase callback will be raised when the purchase is initiated, not completed.

#### DLC offers on Steam e-commerce

When using Steam e-commerce, DLC offers will be suffixed with `dlc:` to the offer IDs. You can only initiate the purchase for one DLC offer at a time, which will open the Steam overlay so the user can purchase the DLC.

Steam requires installing DLC outside of the game after purchasing, so there's no actions to take after DLC is purchased; the user must restart the game, install the DLC and launch the game again.

Refer to [Initating a purchase](#initating-a-purchase-on-any-platform) for an example on how to purchase one or more offers.

#### Item offers on Steam e-commerce

When using Steam e-commerce, item offers will be suffixed with `itemdef:` to the offer IDs. You can purchase as many items as you want at the same time, and can specify quantities for each item. After a successful item purchase, the items will appear as entitlements after you query for them again with `QueryEntitlements`.

Refer to [Initating a purchase](#initating-a-purchase-on-any-platform) for an example on how to purchase one or more offers.

</TabItem>
<TabItem value="google-play">

When using Google Play Billing, in-app purchases will be available with their product IDs as the offer IDs. You can only purchase consumable items on Google Play; subscriptions and non-consumable items are not supported.

After a purchase completes on Google Play, you must award the player the in-app purchase and then call `FinalizePurchase` on the receipt to consume the purchase.

:::caution
If you do not call `FinalizePurchase` when using Google Play, the user's purchase will be automatically refunded after 3 days.
:::

</TabItem>
</Tabs>

## Initating a purchase on any platform

When initiating a purchase, you should use offer IDs that you obtained when [Retrieving offers](offers.mdx). The example below shows offer IDs that you would see on Steam, but the format of offer IDs will differ per-platform.

<Tabs lazy groupId="code-format" defaultValue="c++" values={[ { label: 'C++', value: 'c++' }, { label: 'Blueprints', value: 'blueprints' } ]}>
<TabItem value="c++">

To initiate a purchase, first get the online purchase interface:

```cpp
#include "OnlineSubsystem.h"
#include "OnlineSubsystemUtils.h"
#include "Interfaces/OnlinePurchaseInterface.h"

// ...

IOnlineSubsystem* Subsystem = Online::GetSubsystem(this->GetWorld());
IOnlinePurchasePtr Purchase = Subsystem->GetPurchaseInterface();
```

Then, use `Checkout` to initiate a purchase:

```cpp
// The offer IDs should be obtained from QueryOffersByFilter/GetOffers.
FPurchaseCheckoutRequest Request = {};
Request.AddPurchaseOffer(TEXT(""), TEXT("itemdef:100"), 1);
Request.AddPurchaseOffer(TEXT(""), TEXT("itemdef:200"), 1);

Purchase->Checkout(
    *Identity->GetUniquePlayerId(0).Get(), // The local player to get offers for.
    Request,
    FOnPurchaseCheckoutComplete::CreateLambda([](
        const FOnlineError& Result,
        const TSharedRef<FPurchaseReceipt>& Receipt)
    {
        if (Result.WasSuccessful())
        {
            // Refer to the "Platform Support" section to understand what the
            // Checkout callback represents. On some platforms, it represents
            // the checkout process completing, and on some platforms it only
            // indicates that the process was started.
        }
    })
)
```

</TabItem>
<TabItem value="blueprints">

To initiate a purchase, use the "Checkout" blueprint node.

<Blueprint height="500px" blueprint={bpCheckout} />

</TabItem>
</Tabs>

## Querying and consuming entitlements on Epic Games Store

To consume a purchase that was made on Epic Games Store, you need to:

- [Query for the entitlements](entitlements.mdx#querying-a-list-of-entitlements) the user currently has using the entitlements interface.
- Check the entitlement's `ItemType` attribute to see if it is set to `Consumable`.
- Then call `IOnlinePurchase::FinalizeReceiptValidationInfo` with the entitlement ID passed in as `InReceiptValidationInfo`.

### Consuming an entitlement on Epic Games Store

<Tabs lazy groupId="code-format" defaultValue="c++" values={[ { label: 'C++', value: 'c++' }, { label: 'Blueprints', value: 'blueprints' } ]}>
<TabItem value="c++">

Once you have the entitlement ID from the entitlements interface, call `FinalizeReceiptValidationInfo` and pass the entitlement ID in the `InReceiptValidationInfo` parameter:

```cpp
Purchase->FinalizeReceiptValidationInfo(
    *Identity->GetUniquePlayerId(0).Get(), // The local player to get offers for.
    EntitlementId,                         // The entitlement ID.
    FOnFinalizeReceiptValidationInfoComplete::CreateLambda([
        PurchaseWk = TWeakPtr<IOnlinePurchase, ESPMode::ThreadSafe>(Purchase),
        UserId = this->Identity->GetUniquePlayerId(0)](
        const FOnlineError& Result,
        const FString& ValidationInfo))
    {
        if (auto Purchase = PurchaseWk.Pin())
        {
            if (Result.WasSuccessful())
            {
                // The entitlement was successfully consumed.
            }
        }
    })
)
```

</TabItem>
<TabItem value="blueprints">

Once you have the entitlement ID from the entitlements interface, use the "Finalize Receipt Validation Info" blueprint node and pass in the entitlement ID as the receipt validation info parameter:

<Blueprint height="300px" blueprint={bpFinalize} />

</TabItem>
</Tabs>

## Querying entitlements on Steam

To query what has been purchased on Steam, use the [entitlements interface](entitlements.mdx) to query entitlements.

## Querying receipts and finalizing purchases on Google Play

To finalize purchases on Google Play, you need to check for outstanding receipts and call `FinalizeReceipt`.

### Querying receipts on startup

When the game starts up, you should query for any outstanding receipts so that you can finalize the purchases and award items.

After a purchase is consumed with `FinalizePurchase`, the receipt will no longer appear when querying receipts or calling `GetReceipts`.

<Tabs lazy groupId="code-format" defaultValue="c++" values={[ { label: 'C++', value: 'c++' }, { label: 'Blueprints', value: 'blueprints' } ]}>
<TabItem value="c++">

To query receipts, use `QueryReceipts` to start the query and `GetReceipts` to fetch the receipt data.

```cpp
Purchase->QueryReceipts(
    *Identity->GetUniquePlayerId(0).Get(), // The local player to get offers for.
    true,                                  // This value is ignored.
    FOnQueryReceiptsComplete::CreateLambda([
        PurchaseWk = TWeakPtr<IOnlinePurchase, ESPMode::ThreadSafe>(Purchase),
        UserId = this->Identity->GetUniquePlayerId(0)](
        const FOnlineError& Result)
    {
        if (auto Purchase = PurchaseWk.Pin())
        {
            if (Result.WasSuccessful())
            {
                // Receipts were successfully queried. Access via GetReceipts.
                TArray<FPurchaseReceipt> Receipts;
                Purchase->GetReceipts(*UserId, Receipts);
            }
        }
    })
)
```

</TabItem>
<TabItem value="blueprints">

To query receipts, use "Query Receipts" blueprint node.

<Blueprint height="500px" blueprint={bpQuery} />

</TabItem>
</Tabs>

### Watching for changes to receipts

When a purchase completes on Google Play, the receipt can end up with a `TransactionState` of either `Purchased` or `Deferred`. You must not award items to players until the receipt is in a `Purchased` state.

If a purchase ends up in the `Deferred` state, you may later see the receipt move to the `Purchased` state. When this happens, the `OnUnexpectedPurchaseReceipt` event will fire, and you can re-check the receipts via `GetReceipts` to see if any have moved from `Deferred` to `Purchased`.

You *must* handle deferred purchases on Google Play. Also, you can not know when a deferred purchase fails; this is a limitation of how Google Play Billing works. Instead, you simply don't award items until the receipt moves into a `Purchased` state, so a failed deferred receipt never gets handled by the game.

The `OnUnexpectedPurchaseReceipt` event fires:

- When a deferred purchase moves to the `Purchased` state.
- When a receipt is consumed via `FinalizePurchase` and removed from the `GetReceipts` array.

:::note
The `TransactionId` field of a receipt is the `ReceiptId` to use in other functions.
:::

### Consuming a purchase via `FinalizePurchase`

To acknowledge a purchase on Google Play and consume the purchase, you must call `FinalizePurchase`. If you don't call this function for a receipt, the user's purchase will automatically be refunded 3 days after it moved into the `Purchased` state.

<Tabs lazy groupId="code-format" defaultValue="c++" values={[ { label: 'C++', value: 'c++' }, { label: 'Blueprints', value: 'blueprints' } ]}>
<TabItem value="c++">

To consume a purchase, call `FinalizePurchase`:

```cpp
Purchase->FinalizePurchase(
    *Identity->GetUniquePlayerId(0).Get(), // The local player to get offers for.
    ReceiptId                             // The TransactionId field of the receipt.
);
```

:::caution
There is no callback to pass into `FinalizePurchase`. You can know when the purchase was consumed by listening for the `OnUnexpectedPurchaseReceipt` event.
:::

</TabItem>
<TabItem value="blueprints">

To consume a purchase, use the "Finalize Purchase" blueprint node.

:::caution
This function is not an asynchronous blueprint node, and it returns immediately even before the purchase has been consumed.

If you need to know when the purchase is consumed, listen for the "On Unexpected Purchase Receipt" event and check that the receipt is no longer present when calling "Get Receipts".
:::

<Blueprint height="500px" blueprint={bpConsume} />

</TabItem>
</Tabs>
